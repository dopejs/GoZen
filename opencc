#!/bin/sh
set -eu

CC_VERSION="1.0.0"
CC_ENVS_DIR="$HOME/.cc_envs"

usage() {
  cat <<EOF
Usage: opencc <config-name> [claude args...]
       opencc -l [prefix]

Load environment variables from ~/.cc_envs/<config-name>.env and start claude code.

Options:
  -l, --list              List available configurations
  --setup-completion      Print shell completion code for eval
  --version               Show version
  -h, --help              Show this help

Example:
  opencc work
  opencc personal --model opus
EOF
}

list_configs() {
  prefix="${1:-}"
  found=0
  for f in "$CC_ENVS_DIR"/*.env; do
    [ -f "$f" ] || continue
    name="$(basename "$f" .env)"
    if [ -n "$prefix" ]; then
      case "$name" in
        "$prefix"*) ;;
        *) continue ;;
      esac
    fi
    base_url="" model=""
    while IFS= read -r line || [ -n "$line" ]; do
      case "$line" in
        ""|\#*) continue ;;
      esac
      case "$line" in
        ANTHROPIC_BASE_URL=*) base_url="${line#*=}" ;;
        ANTHROPIC_MODEL=*)    model="${line#*=}" ;;
      esac
    done < "$f"
    printf "  %-12s  model=%-20s  base_url=%s\n" "$name" "${model:--}" "${base_url:--}"
    found=1
  done
  if [ "$found" -eq 0 ]; then
    if [ -n "$prefix" ]; then
      echo "No configurations matching '${prefix}*' in $CC_ENVS_DIR/"
    else
      echo "No configurations found in $CC_ENVS_DIR/"
      echo "Create a .env file, e.g.: $CC_ENVS_DIR/work.env"
    fi
  fi
}

setup_completion() {
  current_shell="$(basename "${SHELL:-/bin/sh}")"
  case "$current_shell" in
    zsh)
      cat <<'COMP'
_opencc() {
  _arguments '1: :_opencc_configs'
}
_opencc_configs() {
  [[ -z "$PREFIX" ]] && return
  local -a configs
  for f in "$HOME/.cc_envs"/*.env(N); do configs+=("${f:t:r}"); done
  compadd -a configs
}
compdef _opencc opencc 2>/dev/null
COMP
      ;;
    bash)
      cat <<'COMP'
_opencc_complete() {
  if (( COMP_CWORD == 1 )); then
    local cur="${COMP_WORDS[1]}"
    [ -z "$cur" ] && return
    local configs=""
    for f in "$HOME/.cc_envs"/*.env; do
      [ -f "$f" ] && configs="$configs $(basename "$f" .env)"
    done
    COMPREPLY=($(compgen -W "$configs" -- "$cur"))
  fi
}
complete -F _opencc_complete opencc
COMP
      ;;
    fish)
      cat <<'COMP'
complete -c opencc -f -n '__fish_is_first_token' -a '(for f in ~/.cc_envs/*.env; basename $f .env; end)'
COMP
      ;;
    *)
      echo "Unsupported shell: $current_shell" >&2
      echo "Supported: zsh, bash, fish" >&2
      return 1
      ;;
  esac
}

load_env() {
  env_file="$1"
  while IFS= read -r line || [ -n "$line" ]; do
    case "$line" in
      ""|\#*) continue ;;
    esac
    # Strip inline comments and export
    clean="${line%%#*}"
    export "$clean"
  done < "$env_file"
}

# --- Main ---

if [ $# -eq 0 ]; then
  usage
  exit 1
fi

case "$1" in
  -l|--list)
    list_configs "${2:-}"
    exit 0
    ;;
  --setup-completion)
    setup_completion
    exit 0
    ;;
  --version)
    echo "opencc $CC_VERSION"
    exit 0
    ;;
  -h|--help)
    usage
    exit 0
    ;;
  -*)
    echo "Unknown option: $1" >&2
    usage >&2
    exit 1
    ;;
esac

config_name="$1"
shift

env_file="$CC_ENVS_DIR/${config_name}.env"

if [ ! -f "$env_file" ]; then
  echo "Error: configuration '$config_name' not found ($env_file)" >&2
  echo "Run 'opencc -l' to see available configurations." >&2
  exit 1
fi

load_env "$env_file"
exec claude "$@"
